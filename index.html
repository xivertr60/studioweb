<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Coche 3D Interactivo</title>
  <style>
    body { margin: 0; overflow: hidden; background: #222; }
    #info {
      position: absolute; top: 10px; left: 10px; z-index: 1;
      color: #fff; font-family: sans-serif; background: rgba(0,0,0,0.5);
      padding: 10px; border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="info">
    <b>Controles:</b> W/S = Acelerar/Frenar, A/D = Girar, Espacio = Sentarse/Cambiar cámara
  </div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    // Escena, cámara y renderizador
    let scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222233);
    let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 6, 16);

    let renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Luces ambientales
    let ambLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambLight);

    let dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight.position.set(0, 10, 10);
    scene.add(dirLight);

    // Piso
    let floor = new THREE.Mesh(
      new THREE.PlaneGeometry(100, 100),
      new THREE.MeshPhongMaterial({color:0x555555, side:THREE.DoubleSide})
    );
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    // Grupo coche
    let car = new THREE.Group();

    // Cuerpo principal
    let body = new THREE.Mesh(
      new THREE.BoxGeometry(4, 1, 8),
      new THREE.MeshPhongMaterial({color:0x1976d2})
    );
    body.position.y = 1.1;
    car.add(body);

    // Techo
    let roof = new THREE.Mesh(
      new THREE.BoxGeometry(3.2, 1, 3.5),
      new THREE.MeshPhongMaterial({color:0xeeeeee})
    );
    roof.position.y = 2;
    roof.position.z = -1;
    car.add(roof);

    // Faros delanteros
    let headlightL = new THREE.Mesh(
      new THREE.CylinderGeometry(0.2,0.2,0.4,16),
      new THREE.MeshBasicMaterial({color:0xffffaa})
    );
    headlightL.rotation.x = Math.PI/2;
    headlightL.position.set(-1.3, 1.2, 4.25);
    car.add(headlightL);

    let headlightR = headlightL.clone();
    headlightR.position.x = 1.3;
    car.add(headlightR);

    // Luces traseras
    let taillightL = new THREE.Mesh(
      new THREE.BoxGeometry(0.2,0.2,0.4),
      new THREE.MeshBasicMaterial({color:0xff3333})
    );
    taillightL.position.set(-1.3, 1.1, -4.25);
    car.add(taillightL);

    let taillightR = taillightL.clone();
    taillightR.position.x = 1.3;
    car.add(taillightR);

    // Luz real de los faros
    let spotLightL = new THREE.SpotLight(0xffffcc, 1.5, 15, Math.PI/8, 0.2, 2);
    spotLightL.position.copy(headlightL.position);
    spotLightL.target.position.set(headlightL.position.x, headlightL.position.y, headlightL.position.z+5);
    car.add(spotLightL);
    car.add(spotLightL.target);

    let spotLightR = new THREE.SpotLight(0xffffcc, 1.5, 15, Math.PI/8, 0.2, 2);
    spotLightR.position.copy(headlightR.position);
    spotLightR.target.position.set(headlightR.position.x, headlightR.position.y, headlightR.position.z+5);
    car.add(spotLightR);
    car.add(spotLightR.target);

    // Ruedas
    let wheelMaterial = new THREE.MeshPhongMaterial({color:0x222222});
    let wheels = [];
    let wheelPositions = [
      [-1.6, 0.5, 2.8], [1.6, 0.5, 2.8], // Frente
      [-1.6, 0.5, -2.8], [1.6, 0.5, -2.8] // Atrás
    ];
    for(let i=0; i<4; i++){
      let wheel = new THREE.Mesh(
        new THREE.CylinderGeometry(0.7, 0.7, 0.7, 24),
        wheelMaterial
      );
      wheel.rotation.z = Math.PI/2;
      wheel.position.set(...wheelPositions[i]);
      car.add(wheel);
      wheels.push(wheel);
    }

    scene.add(car);

    // Variables de movimiento y controles
    let speed = 0, maxSpeed = 0.3, acceleration = 0.01, turnSpeed = 0.03;
    let angle = 0;
    let keys = {};
    let isDriving = false; // vista interna/externa

    // Listeners de teclado
    document.addEventListener("keydown", e => { keys[e.key.toLowerCase()] = true; });
    document.addEventListener("keyup", e => { keys[e.key.toLowerCase()] = false; });

    // Cambiar cámara (sentarse en el coche)
    document.addEventListener("keydown", e => {
      if(e.code === "Space"){
        isDriving = !isDriving;
      }
    });

    // Cámara libre (exterior)
    let orbit = new THREE.OrbitControls(camera, renderer.domElement);
    orbit.target.set(0,1.5,0);

    // Animación principal
    function animate(){
      requestAnimationFrame(animate);

      // Movimiento del coche
      if(keys["w"]){ speed = Math.min(maxSpeed, speed + acceleration); }
      else if(keys["s"]){ speed = Math.max(-maxSpeed/2, speed - acceleration); }
      else { // desaceleración natural
        speed *= 0.96;
        if(Math.abs(speed)<0.005) speed=0;
      }
      if(keys["a"] && Math.abs(speed)>0.01) angle += turnSpeed * Math.sign(speed);
      if(keys["d"] && Math.abs(speed)>0.01) angle -= turnSpeed * Math.sign(speed);

      // Aplicar movimiento
      car.rotation.y = angle;
      car.position.x += Math.sin(angle) * speed;
      car.position.z += Math.cos(angle) * speed;

      // Girar ruedas delanteras para simular dirección
      wheels[0].rotation.y = wheels[1].rotation.y = (keys["a"]?0.3:0) + (keys["d"]?-0.3:0);

      // Animar el giro de ruedas al avanzar
      let wheelSpin = speed * 4;
      for(let i=0;i<4;i++) wheels[i].rotation.x += wheelSpin;

      // Cámara
      if(isDriving){
        // Vista desde dentro (cabina)
        let camPos = new THREE.Vector3(0,2.2,0.8).applyMatrix4(car.matrixWorld);
        let camLook = new THREE.Vector3(0,2.2,4).applyMatrix4(car.matrixWorld);
        camera.position.lerp(camPos, 0.2);
        camera.lookAt(camLook);
        orbit.enabled = false;
      }else{
        // Vista exterior
        let camPos = new THREE.Vector3(0,6,16).applyMatrix4(car.matrixWorld);
        camera.position.lerp(camPos, 0.1);
        camera.lookAt(car.position.x, 1.5, car.position.z);
        orbit.enabled = true;
        orbit.target.copy(car.position);
        orbit.update();
      }

      renderer.render(scene, camera);
    }

    animate();

    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
